:: Clothing Shop v2 Widgets [widget]

<<widget "exitclothingshop">>
	<div class="button-back-to-shop div-link">
		<<if $clothes_choice and $shopDefaults.alwaysBackToShopButton is false>>
			<<link "Back">>
				<<unset $clothes_choice>><<updateclotheslist>><</link>>
		<<else>>
			<<link "Back to shop">><<unset $clothes_choice>><<updateclothingshop>><</link>>
		<</if>>
	</div>
<</widget>>

/*
	args[0] should be "clothing" or "forest"
	args[1] is a slot: "upper", "lower", "under_upper", etc.
	args[2] should be "outfits" or missing. Combination of "over_upper", "upper" or "under_upper" in args[1] with "outfits" provides respective outfits category
*/
<<widget "clothingShopv2">>
	<<exitclothingshop>>
	<<if $args[0]>>
		<<set _shopLocation to $args[0]>>
	<</if>>
	<<if $args[1]>>
		<<set $clothingShopSlot to $args[1]>>
	<</if>>
	<<set _outfits to $args[2] == "outfits" or $args[2] == true>>

	<<if $shopClothingFilter is undefined>>
		<<shopClothingFilterReset>>
	<</if>>
	<<if $shopItemsPerPage is undefined>>
		<<set $shopItemsPerPage = 12>>
	<</if>>

	<<if $shopClothingFilter.active>>
		<span class="green">The filter is currently active!</span>
		<<link "Reset it">>
			<<shopClothingFilterReset>>
			<<updateclotheslist>>
		<</link>>
		<br><br>
	<</if>>

	<!-- Details about the selected item -->
	<div class="clothing-details">
		<<shopDetailsv2>>
	</div>

	<!-- Category tabs at the top of the list -->
	<<set _iconName to clothingSlotToIconName($clothingShopSlot, _outfits)>>
	<<shopCategoryTabs _iconName>>

	<!-- List of clothes -->
	<<set _items = setup.clothes[$clothingShopSlot].filter(x => x.shop.includes(_shopLocation) and x.outfitSecondary is undefined
		and ((_outfits and x.outfitPrimary isnot undefined and Object.keys(x.outfitPrimary).some(secSlot => secSlot.includes("lower")))
			or
			(!_outfits and (x.outfitPrimary is undefined or Object.keys(x.outfitPrimary).every(secSlot => !secSlot.includes("lower")))))
	)>>
	<<set _items = applyClothingShopFilters(_items)>>
	<<set _maxPage = Math.ceil(_items.length / $shopItemsPerPage)>>

	<div id="shop-list-pages" class="shop-list-pages">
		<!-- Generate current page immediately -->
		<<generateshoppage $shopPage>>

		<!-- Generate other pages in background after a delay, so that shop can be displayed sooner -->
		<!-- Having all pages loaded allows for very fast shop catalogue navigation -->
		<!-- Generate via <<repeat>> one by one to not cause a lag spike -->
		<<timed 0.2s>>
			<<set _ppre = $shopPage - 1>>
			<<repeat 0.1s>>
				<!-- Prepend pages before the current page -->
				<<if _ppre >= 0>>
					<<prepend '#shop-list-pages'>>
						<<generateshoppage _ppre>>
					<</prepend>>
					<<set _ppre-->>
				<<else>>
					<<stop>>
				<</if>>
			<</repeat>>
			<!-- Append pages after the current page -->
			<<set _papp = $shopPage + 1>>
			<<repeat 0.1s>>
				<<if _papp < _maxPage>>
					<<append '#shop-list-pages'>>
						<<generateshoppage _papp>>
					<</append>>
					<<set _papp++>>
				<<else>>
					<<stop>>
				<</if>>
			<</repeat>>
		<</timed>>
	</div>

	<!-- Pages -->
	<div id="shop-pagination" class="shop-pagination">
		<<set _disabled = $shopPage > 0 ? "" : "disabled">>
		<div @class="'div-link btn-pagination prev ' + _disabled">
			<<link "Previous">>
				<<if $shopPage > 0>>
					<<set $shopPage -= 1>>
					<<clothingshopChangePage>>
				<</if>>
			<</link>>
			<div class="btn-pagination-arrow">&lt;</div>
		</div>
		<div class="shop-pages no-numberify">
			<<for _i = 0; _i < _maxPage; _i++>>
				<<capture _i>>
					<<set _active = _i == $shopPage ? "active" : "">>
					<div @class="'div-link page ' + _active">
						<<link "">>
							<<set $shopPage = _i>>
							<<clothingshopChangePage>>
						<</link>>
					</div>
				<</capture>>
			<</for>>
		</div>
		<div class="shop-pages-number hidden">
			<<print ($shopPage + 1) + " out of " + _maxPage>>
		</div>
		<<set _disabled = $shopPage < _maxPage - 1 ? "" : "disabled">>
		<div @class="'div-link btn-pagination next ' + _disabled">
			<<link "Next">>
				<<if $shopPage < _maxPage - 1>>
					<<set $shopPage += 1>>
					<<clothingshopChangePage>>
				<</if>>
			<</link>>
			<div class="btn-pagination-arrow">&gt;</div>
		</div>
	</div>

	<!-- Attach screen resize listener to replace circles in paginator with numbers when not enough space (22px per one circle is min) -->
	<<run $(window).on('resize', () => {
		let pagination = $('#shop-pagination');
		let pages = $(pagination).find('.shop-pages');
		let buttons = $(pagination).find('.btn-pagination');
		let isEnoughSpace = (pagination.width() - buttons.outerWidth() * 2 - 32) / pages.children().length >= 22;

		pages.toggleClass('hidden', !isEnoughSpace);
		pagination.find('.shop-pages-number').toggleClass('hidden', isEnoughSpace);
	})>>

	<!-- Filters -->
	<div class="filters-button no-numberify div-link">
		<<if $images is 1>>
			<span class="button-icon"><img src="img/misc/icon/filter.png"></span>
		<<else>>
			Filters
		<</if>>
		<<link "">>
			<<replace '#filters'>><<loadFiltersMenu>><</replace>>
			<<run linkifyDivs('#filters')>>
			<<toggleclass '#filters' 'hidden'>>
		<</link>>
	</div>
	<div id="filters" class="no-click-overlay no-numberify hidden" onclick="$(this).addClass('hidden')">
		<!-- Don't load filters menu right away to not slow down shop loading -->
	</div>

	<!-- Options -->
	<div class="clothingshop-options-button no-numberify div-link">
		<<if $images is 1>>
			<span class="button-icon"><img src="img/misc/icon/options.png"></span>
		<<else>>
			Opt.
		<</if>>
		<<link "">>
			<<replace '#shop-options'>><<loadShopOptions>><</replace>>
			<<run linkifyDivs('#shop-options')>>
			<<toggleclass '#shop-options' 'hidden'>>
		<</link>>
	</div>
	<div id="shop-options" class="no-click-overlay no-numberify hidden" onclick="$(this).addClass('hidden')">
		<!-- Don't load options menu right away to not slow down shop loading -->
	</div>

	<!-- Help / Legend button -->
	<<if !$shopDefaults.noHelp>>
		<div class="shop-legend-button no-numberify div-link">
			<<if $images is 1>>
				<span class="button-icon"><img src="img/misc/icon/help.png"></span>
			<<else>>
				Help
			<</if>>
			<<link "">>
				<<toggleclass '#shop-legend' 'hidden'>>
				<<toggleclass '.shop-legend-button' 'active'>>
			<</link>>
		</div>
		<<clothingShopLegend>>
	<</if>>

	<!-- Finishing JS logic -->
	<<run linkifyDivs('#clothingShop-div')>>
	<<numberify '#clothingShop-div'>>
	<<run $(() => {
		_maxW = Math.max($('.btn-pagination.next').width(), $('.btn-pagination.prev').width());
		$('.btn-pagination.prev').width(_maxW);
		$('.btn-pagination.next').width(_maxW);
	})>>
<</widget>>

<<widget "clothingshopChangePage">>
	<!-- Make selected page visible -->
	<<run $('#shop-list-pages > div.clothing-shop-page').addClass('hidden no-numberify')>>
	<<run $('#shop-list-pages > div.clothing-shop-page:nth-of-type(' + ($shopPage + 1) + ')').removeClass('hidden no-numberify')>>

	<!-- Highlight selected page indicator -->
	<<run $('#shop-pagination > .shop-pages > div.page').removeClass('active')>>
	<<run $('#shop-pagination > .shop-pages > div.page:nth-of-type(' + ($shopPage + 1) + ')').addClass('active')>>

	<!-- Activate/deactivate Prev/Next buttons -->
	<<run $('#shop-pagination > .btn-pagination.prev').toggleClass('disabled', $shopPage <= 0)>>
	<<run $('#shop-pagination > .btn-pagination.next').toggleClass('disabled', $shopPage >= _maxPage - 1)>>

	<!-- Re-generate keyboard shortcuts -->
	<<run Links.generateLinkNumbers($('#clothingShop-div'))>>

	<!-- Change page number text on small screens -->
	<<replace '#shop-pagination > .shop-pages-number'>><<print ($shopPage + 1) + " out of " + _maxPage>><</replace>>
<</widget>>

<<widget "generateshoppage">>
	<<set _page = $args[0]>>
	<<set _itemsOnPage = _items.slice(_page * $shopItemsPerPage, (_page + 1) * $shopItemsPerPage)>>
	<<set _hidden = _page == $shopPage ? "" : " hidden">>
	<<set _compact = $shopDefaults.compactMode ? "compact" : "">>

	<<set _colCustomPrimary = getCustomColourStyle('primary')>>
	<<set _colCustomSecondary = getCustomColourStyle('secondary')>>

	<div @class="'clothing-shop-page page-' + _page + _hidden">
		<<for _itemTemp range _itemsOnPage>>
			<<set _item = clone(_itemTemp)>>
			<<set _locked = $specialClothes[_item.name.replace(/ /g,"")] is "locked">>
			<<set _unlocked = $specialClothes[_item.name.replace(/ /g,"")] is "unlocked">>
			<div class="clothing-item div-link">
				<!-- Clothing icon -->
				<div @class="'clothing-icon ' + _compact">
					<<if _locked and $images is 1>>
						<img src="img/misc/icon/lock.png" class="clothing-locked">
					<<else>>
						<<if _item.colour_options.length > 0>>
							<<if $shopDefaults.colourItems == "random">>
								<<set _item.colour = _item.colour_options[random(_item.colour_options.length - 1)]>>
							<<elseif $shopDefaults.colourItems == "default" and _item.colour_options.includes($shopDefaults.color)>>
								<<set _item.colour = $shopDefaults.color>>
								<<if $shopDefaults.color == "custom">>
									<<set _item.colourCustom = _colCustomPrimary>>
								<</if>>
							<</if>>
						<</if>>
						<<if _item.accessory_colour_options.length > 0>>
							<<if $shopDefaults.colourItems == "random">>
								<<set _item.accessory_colour = _item.accessory_colour_options[random(_item.accessory_colour_options.length - 1)]>>
							<<elseif $shopDefaults.colourItems == "default" and _item.accessory_colour_options.includes($shopDefaults.secColor)>>
								<<set _item.accessory_colour = $shopDefaults.secColor>>
								<<if $shopDefaults.secColor == "custom">>
									<<set _item.accessory_colourCustom = _colCustomSecondary>>
								<</if>>
							<</if>>
						<</if>>
						<<clothingicon _item>>
						<!-- Gender icon -->
						<<if _item.gender isnot "n">>
							<span class="clothing-gender">
								<<if $shopDefaults.compactMode>>
									<<if _item.gender is "m">>
										<div class="male"></div>
									<<elseif _item.gender is "f">>
										<div class="female"></div>
									<</if>>
								<<else>>
									<<if $images is 1>>
										<<if _item.gender is "m">>
											<img src="img/misc/icon/male.png" class="male">
										<<elseif _item.gender is "f">>
											<img src="img/misc/icon/female.png" class="female">
										<</if>>
									<<else>>
										<<if _item.gender is "m">>
											<span class="male blue bold">♂</span>
										<<elseif _item.gender is "f">>
											<span class="female pink bold">♀</span>
										<</if>>
									<</if>>
								<</if>>
							</span>
						<</if>>
					<</if>>
				</div>

				<div @class="'clothing-body ' + _compact">
					<<if !$shopDefaults.compactMode>>
						<div class="pricetag-placeholder"></div>
					<</if>>
					<span class="clothing-name">
						<<if _locked>>
							<span class="lblue">_item.name_cap</span><span class="black">&nbsp;| Locked</span>
						<<else>>
							<<set _csslot = $clothingShopSlot>>
							<<capture _item _shopLocation _csslot _outfits>>
								<<link _item.name_cap>>
									<<set $clothes_choice = _item.index>>
									<<set $clothes_choice_reveal = _item.reveal>>
									<<set $clothes_choice_integrity = _item.integrity_max>>
									<<unset $colouraction>>
									<<unset $accessorycolouraction>>
									<<run window.scrollTo(0, 0)>>
									<<updateclotheslist _shopLocation _csslot _outfits>>
								<</link>>
							<</capture>>
							<<if _unlocked>>
								<span class="gold">&nbsp;| Unlocked</span>
							<</if>>
						<</if>>
					</span>

					<<if _locked>>
						<div class="locked-hint">
							<<specialClothesHint>>
							<<print _specialClothesHint[_item.name.replace(/ /g,"")]>>
						</div>
					<<else>>
						<!-- Price tag -->
						<span class="clothing-price"><<printmoney `getClothingCost(_item)` true>></span>
						<!-- Integrity, Reveal and Warmth indicators -->
						<<if !$shopDefaults.compactMode>>
							<div class="clothing-integrity">
								<<if $images is 1>>
									<img class="clothing-stats-icon" src="img/misc/icon/integrity.png">
								<<else>>
									<span class="clothing-stats-text">I.</span>
								<</if>>
								<<set _intInf = getIntegrityInfo(_item.integrity_max)>>
								<<for _i = 0; _i lt 7; _i++>>
									<span @class="'stats-ball ' + (_i < _intInf[0] ? 'bg-' + _intInf[1] : '')">&nbsp;</span>
								<</for>>
							</div>
							<div class="clothing-reveal">
								<<if $images is 1>>
									<img class="clothing-stats-icon" src="img/misc/icon/reveal.png">
								<<else>>
									<span class="clothing-stats-text">R.</span>
								<</if>>
								<<set _revInf = getRevealInfo(_item.reveal)>>
								<<for _i = 0; _i lt 7; _i++>>
									<span @class="'stats-ball ' + (_i < _revInf[0] ? 'bg-' + _revInf[1] : '')">&nbsp;</span>
								<</for>>
							</div>
							<div class="clothing-warmth">
								<<if $images is 1>>
									<img class="clothing-stats-icon" src="img/misc/icon/warmth.png">
								<<else>>
									<span class="clothing-stats-text">W.</span>
								<</if>>
								<<set _warInf = getWarmthInfo(getTrueWarmth(_item))>>
								<<for _i = 0; _i lt 5; _i++>>
									<span @class="'stats-ball ' + (_i < _warInf[0] ? _warInf[1] : '')">&nbsp;</span>
								<</for>>
							</div>
						<</if>>
						<<if !$shopDefaults.noTraits>>
							<!-- Trait icons -->
							<div class="clothing-traits">
								<<for _i, _trait range _item.type>>
									<<clothingtrait _trait>>
								<</for>>
							</div>
						<</if>>
					<</if>>
					<<if $shopDefaults.compactMode>>
						<div class="pricetag-placeholder"></div>
					<</if>>
				</div>
			</div>
		<</for>>

		<!-- Empty slots for padding when there's not enough clothes to show -->
		<<for _i = 0; _i < $shopItemsPerPage - _itemsOnPage.length; _i++>>
			<div @class="'clothing-item-spacer ' + _compact"></div>
		<</for>>

		<!-- Make div-links generated here clickable. -->
		<!-- Make sure to linkify ONLY this page, otherwise other, already linkified, divs will have two event handlers attached to them and will execute twice per click -->
		<<run linkifyDivs('#shop-list-pages > .clothing-shop-page.page-' + _page)>>
	</div>
<</widget>>

<<widget "updateclotheslist">>
	<<set _shop = $args[0] or _shopLocation>>
	<<set _slot = $args[1] or $clothingShopSlot>>
	<<set _outf = $args[2] or _outfits>>
	<<replace "#clothes-list">><<clothingShopv2 _shop _slot _outf>><</replace>>
<</widget>>

<<widget "clothingtrait">>
	<<if $images is 1 and ($args[1] or $args[0] isnot "normal")>>
		<img @src="'img/misc/icon/clothes/traits/' + $args[0] + '.png'" class="clothing-trait">
	<</if>>
<</widget>>

<<widget "shopDetailsv2">>
	<<unset _mannequinGenderOverrite>>
	<<if $clothes_choice and setup.clothes[$clothingShopSlot][$clothes_choice] is undefined>>
		<<unset $clothes_choice>>

	<<elseif $clothes_choice>>
		<<set _temp_choice to clone(setup.clothes[$clothingShopSlot][$clothes_choice])>>

		<!-- Unlocked text -->
		<<if $specialClothes[_temp_choice.name.replace(/ /g,"")] is "unlocked">>
			<<specialClothesHint>>
			<div class="unlocked-hint">
				<span class="gold">Unlocked | </span><span class="grey"><<print _specialClothesHint[_temp_choice.name.replace(/ /g,"")]>></span>
			</div>
			<br>
		<</if>>

		<<if _temp_choice.plural is 1>>
			<<integrity $clothes_choice_integrity "cap">>
		<<else>>
			A <<integrity $clothes_choice_integrity>>
		<</if>>
		and <<reveal $clothes_choice_reveal>> <<print _temp_choice.name>>.
		<<if _temp_choice.gender is "m">>
			<span class="lblue">For boys.</span>
		<<elseif _temp_choice.gender is "f">>
			<span class="pink">For girls.</span>
		<</if>>
		<<print _temp_choice.description>> Costs <<printmoney `getClothingCost(_temp_choice)`>>.
		<br>
		<<set _truewarmth = getTrueWarmth(_temp_choice)>>
		<<warmth _truewarmth>>
		<br><br>
		<<shoptraits>>
		<<set _slimeSlots to ["over_upper","over_lower","upper","lower","under_upper","under_lower"]>>
		<<if !_slimeSlots.includes($clothingShopSlot) or $willpower gte 800 or _temp_choice.reveal gte 500 or _temp_choice.type.includesAny("school", "event") or $corruption_slime lt 80>>
			<div class="clothing-colours-div">
				<<set _hiddenMannequin = $images is 1 ? "" : "hidden">>
				<!-- Item preview -->
				<div id="mannequin" @class="'mannequin ' + _hiddenMannequin + ($sidebarRenderer is 'both' ? ' both-renderers' : '')">
					<<mannequin>>
				</div>
				<!-- Item colour selection -->
				<<set _translate = $images is 1 ? "translate-colours-container" : "">>
				<div @class="'colours-container ' + _translate">
					<div @class="'mannequin-placeholder ' + _hiddenMannequin"></div>
					<<if _temp_choice.colour_options.length gt 1>>
						<<run _temp_choice.colour_options.pushUnique("random")>>
						There's a range of colours to choose from:
						<br>
						<<printShopColourOptions>>
					<</if>>
					<<if _temp_choice.accessory_colour_options.length isnot 0>>
						<<run _temp_choice.accessory_colour_options.pushUnique("random")>>
						<br>
						Secondary colour:
						<br>
						<<printShopColourOptions "secondary">>
					<</if>>
				</div>
			</div>
			<<run attachCustomColourHooks($clothingShopSlot)>>

			<!-- Check if current clothing can be unequiped -->
			<<unset _cursedPrevent>>
			<<set _preventSlots to []>>
			<<if $worn[$clothingShopSlot].cursed is 1>>
				<<set _cursedPrevent to true>>
				<<run _preventSlots.push($clothingShopSlot)>>
			<</if>>
			<<set _wardrobeSlots to [$clothingShopSlot]>>
			<<if _temp_choice.outfitPrimary isnot undefined>>
				<<for _slot, _name range _temp_choice.outfitPrimary>>
					<<run _wardrobeSlots.push(_slot)>>
					<<if $worn[_slot].cursed is 1>>
						<<set _cursedPrevent to true>>
						<<run _preventSlots.push(_slot)>>
					<</if>>
				<</for>>
			<</if>>

			<span>Warmth:</span>
			<<warmthscale>>
			<div id="warmth-description">
				<<warmth_description>>
			</div>
			<br><br>
			<<shopBuyItemStatus _wardrobeSlots>>
			<<if _spaceLeft < 1>>
				<span class="blue">Your wardrobe is full.</span>
				<br>
			<<elseif $daystate is "night">>
				<<if $clothingShop.stolenClothes lte 20>>
					<<if $worn[$clothingShopSlot].cursed is 1>>
						<<printcursed>>
					<<else>>
						<<link "Steal and wear">>
							<<shopbuyv2 $clothingShopSlot "steal" "wear" $clothes_choice>><<crimeup `getClothingCost(_temp_choice) / 100`>>
							<<set $clothingShop.stolenClothes++>>
							<<set $clothingShop.totalStolenClothes++>>
							<<if $shopDefaults.disableReturn is false>>
								<<unset $clothes_choice>>
							<</if>>
							<<updateclotheslist>>
							<<updatesidebarimg>>
							<<updatesidebarmoney>>
							<<updatesidebardescription>>
							<<updateallure>>
							<<if $shopDefaults.disableReturn>>
								<<updatewarmthscale>>
								<<updatewarmthdescription>>
							<</if>>
							<<run updateMoment()>>
						<</link>><<crime>>
						<br>
					<</if>>
					<<link "Steal and take home">>
						<<shopbuyv2 $clothingShopSlot "steal" "send" $clothes_choice>><<crimeup `getClothingCost(_temp_choice) / 100`>>
						<<set $clothingShop.stolenClothes++>>
						<<set $clothingShop.totalStolenClothes++>>
						<<if $shopDefaults.disableReturn is false>>
							<<unset $clothes_choice>>
						<</if>>
						<<updateclotheslist>>
						<<updatesidebarimg>>
						<<run updateMoment()>>
					<</link>><<crime>>
					<br>
				<<else>>
					<span class="red">You can't carry any more clothes with you.</span> You should take them to your wardrobe.
					<br>
				<</if>>
			<<elseif $money >= getClothingCost(_temp_choice)>>
				<<if _cursedPrevent>>
					<<printcursed>>
				<</if>>

				<div class="buy-buttons">
					<<set _cantWear = _cursedPrevent == true ? "disabled" : "div-link">>
					<div class="buy-button">
						<div @class="'buy-button-inner ' + _cantWear">
							<<if _cursedPrevent>>
								Buy and wear
							<<else>>
								<<link "Buy and wear">>
									<<clothingReset $clothingShopSlot>>
									<<shopbuyv2 $clothingShopSlot "buy" "wear" $clothes_choice>>
									<<set $money -= getClothingCost(_temp_choice)>>
									<<if $shopDefaults.disableReturn is "false">>
										<<unset $clothes_choice>>
									<</if>>
									<<updateclotheslist>>
									<<exposedcheck>>
									<<updatesidebarimg>>
									<<updatesidebarmoney>>
									<<updatesidebardescription>>
									<<updateallure>>
									<<if $shopDefaults.disableReturn>>
										<<updatewarmthscale>>
										<<updatewarmthdescription>>
									<</if>>
									<<run updateMoment()>>
								<</link>>
								(<<printmoney `getClothingCost(_temp_choice)`>>)
							<</if>>
						</div>
					</div>
					<<if $buyMultiple is undefined>>
						<<set $buyMultiple = 1>>
					<</if>>
					<div id="buy-send-home">
						<<printbuysendhome>>
					</div>
				</div>
			<<else>>
				<span class="pink">You cannot afford this item.</span>
				<br>
			<</if>>

			<<if _cursedPrevent != true and $tryOn.tryingOn>>
				<div class="try-buttons">
					<div class="try-button div-link">
						<<link "Try On">>
							<<shopbuyv2 $clothingShopSlot "try" null $clothes_choice>>
							<<updateclotheslist>>
							<<exposedcheck>>
							<<updatesidebarimg>>
							<<updatesidebardescription>>
							<<updateallure>>
							<<updatewarmthscale>>
							<<updatewarmthdescription>>
							<<run updateMoment()>>
						<</link>>
					</div>
					<<if $tryOn.tryingOn[$clothingShopSlot] isnot null>>
						<div class="try-button div-link">
							<<link "Return">>
								<<shopbuyv2 $clothingShopSlot "return" null $clothes_choice>>
								<<updateclotheslist>>
								<<exposedcheck>>
								<<updatesidebarimg>>
								<<updatesidebardescription>>
								<<updateallure>>
								<<updatewarmthscale>>
								<<updatewarmthdescription>>
								<<run updateMoment()>>
							<</link>>
						</div>
					<</if>>
				</div>
			<</if>>
		<<else>>
			<span class="red">The slime in your ear refuses to allow you to try on or buy the _temp_choice.name.</span>
			<br>
		<</if>>
	<</if>>
<</widget>>

<<widget "printbuysendhome">>
	<<set _canAfford = ($money >= getClothingCost(_temp_choice) * $buyMultiple and _spaceLeft >= $buyMultiple) ? "" : "disabled">>
	<div class="buy-button">
		<div @class="'buy-button-inner buy-multiple div-link ' + _canAfford">
				<<link `'Buy and send home × ' + $buyMultiple`>>
					<<if $money >= getClothingCost(_temp_choice) * $buyMultiple and _spaceLeft >= $buyMultiple>>
						<<clothingReset $clothingShopSlot>>
						<<shopbuyv2 $clothingShopSlot "buy" "send" $clothes_choice $buyMultiple>>
						<<set $money -= getClothingCost(_temp_choice) * $buyMultiple>>
						<<if $shopDefaults.disableReturn is false>>
							<<unset $clothes_choice>>
						<</if>>
						<<updateclotheslist>>
						<<updatesidebarimg>>
						<<updatesidebarmoney>>
						<<run updateMoment()>>
					<</if>>
				<</link>>
				<span>(<span class="gold"><<print getClothingCost(_temp_choice) * $buyMultiple / 100>></span>)</span>
		</div>

		<div id="buy-multiple-slider" class="buy-multiple-slider">
			<<numberslider "$buyMultiple" $buyMultiple 1 10 1>>
		</div>
		<!-- Update text of "Buy and send home" button -->
		<!-- <<run $(() => { $('#buy-multiple-slider input').on('change', () => { new Wikifier (null, "<<updateclotheslist>>") }); })>> -->
		<<run $(() => { $('#buy-multiple-slider input').on('input change', () => {
				let el = $('#buy-send-home > .buy-button > .buy-button-inner > a');
				let text = el.text().split(' ');
				text.pop();
				text.push($buyMultiple);
				el.text(text.join(' '));

				$('#buy-send-home > .buy-button > .buy-button-inner > span > span').text('£' + getClothingCost(_temp_choice) * $buyMultiple / 100);
				$('#buy-send-home > .buy-button > .buy-button-inner').toggleClass('disabled', $money < getClothingCost(_temp_choice) * $buyMultiple or _spaceLeft < $buyMultiple);
			});
		})>>
	</div>
<</widget>>

<<widget "updatebuysendhome">>
	<<replace "#buy-send-home">><<printbuysendhome>><</replace>>
	<<run linkifyDivs('#buy-send-home')>>
	<<numberify '#buy-send-home'>>
<</widget>>

<<widget "printShopColourOptions">>
	<<set _colourType = $args[0] == "secondary" ? "accessory_colour_options" : "colour_options">>

	<!-- Reset colour to default if invalid -->
	<<if $args[0] == "secondary" and !$accessorycolouraction and setup.clothes[$clothingShopSlot][$clothes_choice][_colourType].includes($shopDefaults.secColor)>>
		<<set $accessorycolouraction = $shopDefaults.secColor>>
	<<elseif !$colouraction and setup.clothes[$clothingShopSlot][$clothes_choice][_colourType].includes($shopDefaults.color)>>
		<<set $colouraction = $shopDefaults.color>>
	<</if>>
	<<set _acc = $args[0] == "secondary" ? "secondary" : "primary">>

	<!-- Generate button for each colour -->
	<<set _highContrast = $shopDefaults.highContrast ? "colour-name-span-highcontrast" : "colour-name-span">>
	<div @class="'colour-options-div no-numberify ' + _acc">
		<<for _buttonName range _temp_choice[_colourType]>>
			<<set _active = (_acc == "primary" ? $colouraction : $accessorycolouraction) == _buttonName ? "active" : "">>
			<div @class="'colour-button div-link ' + _active">
				<div @class="'bg-' + _buttonName.replace(/ /g, '-')">
					<<if $images is 1>>
						<<if _buttonName == "custom">>
							<img src="img/misc/icon/custom.png">
						<</if>>
						<<if _buttonName == "random">>
							<img src="img/misc/icon/random.png">
						<</if>>
					<</if>>
					<span @class="'capitalize ' + _highContrast">_buttonName</span>
					<<capture _buttonName $args[0] _acc $clothingShopSlot>>
						<<link "">>
							<<if _buttonName == "random">>
								<<set _col_array = setup.clothes[$clothingShopSlot][$clothes_choice][_colourType]>>
								<<set _colour = _col_array[Math.floor(Math.random() * _col_array.length)]>>
							<<else>>
								<<set _colour = _buttonName>>
							<</if>>
							<<if $args[0] == "secondary">>
								<<set $accessorycolouraction = _colour>>
							<<else>>
								<<set $colouraction = _colour>>
							<</if>>
							<<if _colour == "custom">>
								<<removeclass `".custom-colour." + _acc` "hidden">>
							<<else>>
								<<addclass `".custom-colour." + _acc` "hidden">>
							<</if>>
							<!-- Move .active class to the button that was pressed -->
							<<run $('.colour-options-div.' + _acc + ' > .colour-button').removeClass('active').find('.bg-' + _colour).parent().addClass('active')>>
							<<updatemannequin>>
						<</link>>
					<</capture>>
				</div>
			</div>
		<</for>>
		<!-- Update colour filters of custom colour button -->
		<<run $(() => { updateCustomColour('primary'); updateCustomColour('secondary'); })>>

		<!-- Set colouractions to default if they're undefined, set by clicking on respective buttons -->
		<<if _acc == "primary" and $colouraction is undefined>>
			<<run $(() => { $('.colour-options-div.primary > .colour-button > .bg-' + $shopDefaults.color + ' > a').click(); })>>
		<</if>>
		<<if _acc == "secondary" and $accessorycolouraction is undefined>>
			<<run $(() => { $('.colour-options-div.secondary > .colour-button > .bg-' + $shopDefaults.secColor + ' > a').click(); })>>
		<</if>>
	</div>

	<!-- Custom colour sliders -->
	<<if $args[0] == "secondary">>
		<<set _hidden = $accessorycolouraction == "custom" ? "" : " hidden">>
	<<else>>
		<<set _hidden = $colouraction == "custom" ? "" : " hidden">>
	<</if>>
	<<capture _acc $clothingShopSlot>>
		<div @class="'custom-colour ' + _acc + _hidden">
			<div @class="'custom-colour-sliders ' + _acc">
				<<set _varHue = "$customColors.color." + _acc>>
				<<set _varBri = "$customColors.brightness." + _acc>>
				<<set _varSat = "$customColors.saturation." + _acc>>
				<<set _varCon = "$customColors.contrast." + _acc>>
				<div class="colour-slider"><span class="colour-slider-caption">Hue</span><<numberslider _varHue $customColors.color[_acc] 0 360 1>></div>
				<div class="colour-slider"><span class="colour-slider-caption">Brightness</span><<numberslider _varBri $customColors.brightness[_acc] 0 4 0.01>></div>
				<div class="colour-slider"><span class="colour-slider-caption">Saturation</span><<numberslider _varSat $customColors.saturation[_acc] 0 4 0.01>></div>
				<div class="colour-slider"><span class="colour-slider-caption">Contrast</span><<numberslider _varCon $customColors.contrast[_acc] 0 4 0.01>></div>
			</div>
			<div class="custom-colour-presets no-numberify">
				<div class="presets-dropdown">
					<<if _preset_choice is undefined>><<set _preset_choice = {}>><</if>>
					<<listbox "_preset_choice[_acc]" autoselect>>
						<!-- Just... don't try to understand the next line. In short, it adds [L] to legacy preset names in dropdown -->
						<<optionsfrom {...{'---': '---'}, ...Object.keys($customColors.presets).reduce((acc, val) => ({...acc, [($customColors.presets[val].ver >= 2 ? '' : '[L] ') + val]: val }), {})}>>
					<</listbox>>
					<<set _delDisabled = Object.keys($customColors.presets).includes(_preset_choice[_acc]) ? "" : "disabled">>
					<div @class="'delete-preset div-link ' + _delDisabled">
						<<if $images is 1>><img src="img/misc/icon/delete.png"><<else>>Del<</if>>
						<<link "">>
							<<if _preset_choice[_acc] and $customColors.presets[_preset_choice[_acc]] and confirm('Delete preset "' + _preset_choice[_acc] + '"?')>>
								<<run delete $customColors.presets[_preset_choice[_acc]]>>
								<<updateclotheslist>>
								<<run updateMoment()>>
							<</if>>
						<</link>>
					</div>
				</div>
				<div class="save-preset div-link">
					<<if $images is 1>><img src="img/misc/icon/save.png"><<else>>Save<</if>>
					<<link "">>
						<<run saveCustomColourPreset(_acc)>>
						<<updateclotheslist>>
						<<run updateMoment()>>
					<</link>>
				</div>
			</div>
		</div>
	<</capture>>
<</widget>>

<<widget "printcursed">>
	<span class="blue">You can't wear this item without first removing your
	<<set _preventClothes = _preventSlots.map(x => $worn[x].name)>>
	<<if _preventClothes.length > 1>><<print _preventClothes.slice(0, -1).join(', ') + ' and '>><</if>>
	<<print _preventClothes.slice(-1)>>.</span>
	<br>
<</widget>>


<<widget "shopbuyv2">>
	<<set _slot to $args[0]>>
	<<set _action to $args[1]>>
	<<set _subaction to $args[2]>>
	<<set _choice_index to $args[3]>>
	<<set _amount to $args[4]>>
	<<set $clothes_choice_previous to $clothes_choice>>

	<<if _choice_index isnot undefined>>
		<<set $colouraction2 = $colouraction>>
		<<set $accessorycolouraction2 = $accessorycolouraction>>
	<</if>>

	<<if _action isnot "reset">>
		<<if _slot is "upper" or _slot is "lower">>
			<<ShowUnderEquip "normal">>
		<</if>>
		<<if _slot is "over_upper" or _slot is "over_lower" or _slot is "over_head">>
			<<ShowUnderEquip "over">>
		<</if>>
	<</if>>

	<<if _action is "buy" or _action is "steal">>
		You _action the <<print setup.clothes[_slot][_choice_index].name>>.
		<br><br>
	<<elseif _action is "try">>
		<<tryOnWear _slot _choice_index>>
	<<elseif _action is "return">>
		<<clothingReset _slot>>
	<<elseif _action is "reset">>
		<<unset $colouraction>>
		<<unset $colouraction2>>
		<<unset $accessorycolouraction>>
		<<unset $accessorycolouraction2>>
		<<set $shopDefaults.colorSet to null>>
		<<set $shopDefaults.secColorSet to null>>
	<</if>>

	<<if _subaction is "wear">>
		<<generalWear _slot _choice_index $colouraction2 $accessorycolouraction2>>
		<<updateOwned _slot>>
	<<elseif _subaction is "send">>
		<<set _loop to _amount or 1>>
		<<for _s = 0; _s lt _loop; _s++>>
			<<generalSend "wardrobe" _slot _choice_index $colouraction2 $accessorycolouraction2>>
		<</for>>
	<</if>>

<</widget>>

<<widget "mannequin">>
	<<if $images is 1>>
		<<set _slot = $args[0] or $clothingShopSlot>>
		<<set _index = $args[1] or $clothes_choice>>
		<<set _item = setup.clothes[_slot][_index]>>

		<<if _item.colour_options.length > 0>>
			<<set _col = $args[2] or $colouraction or (_item.colour_options.includes($shopDefaults.color) ? $shopDefaults.color : _item.colour_options[0])>>
		<<else>>
			<<set _col = "">>
		<</if>>
		<<if _item.accessory_colour_options.length > 0>>
			<<set _acc_col = $args[3] or $accessorycolouraction or (_item.accessory_colour_options.includes($shopDefaults.secColor) ? $shopDefaults.secColor : _item.accessory_colour_options[0])>>
		<<else>>
			<<set _acc_col = "">>
		<</if>>

		<<if _item>>
			<!-- Set gender of the mannequin -->
			<<if _mannequinGenderOverrite>>
				<<set _mannequinGender = _mannequinGenderOverrite>>
			<<else>>
				<<if $shopDefaults.mannequinGenderFromClothes and _item.gender != "n">>
					<<set _mannequinGender = _item.gender>>
				<<else>>
					<<if $shopDefaults.mannequinGender == "same">>
						<<set _mannequinGender = $player.gender>>
					<<elseif $shopDefaults.mannequinGender == "opposite">>
						<<set _mannequinGender = $player.gender == "f" ? "m" : "f">>
					<<else>>
						<<set _mannequinGender = $shopDefaults.mannequinGender.first()>>
					<</if>>
				<</if>>
			<</if>>
			<<if _mannequinGender == "m" or _mannequinGender == "h">>
				<<set $mannequinHasPenis = 1>>
			<<else>>
				<<set $mannequinHasPenis = 0>>
			<</if>>

			<<if _item.type.includes("chest_bind")>>
				<<set _breastImg = 0>>
			<<else>>
				<<set _breastImg = $mannequinBreastsSize is undefined ? 3 : (_mannequinGender == "f" or _mannequinGender == "h" ? $mannequinBreastsSize : 0)>>
			<</if>>
			<<set _clothed = (((_slot != "under_upper" and $neverNudeMenus) or (_slot == "under_upper" and !_item.type.includes("naked"))) and _breastImg >= 2) ? "_clothed" : "">>

			<div class="mannequin-inner">
				<<if $sidebarRenderer isnot "img">>
					<<selectmodel "main" "shop">>
						<<set _modeloptions.mannequin to true>>
						<<set _modeloptions.show_face to false>>
						<<set _modeloptions.show_hair to false>>
						<<set _modeloptions.breasts to _breastImg ? (_clothed ? "cleavage" : "default") : "">>
						<<set _modeloptions.breast_size to _breastImg>>
						<<set _modeloptions.crotch_visible to true>>
						<<if $mannequinHasPenis>>
							<<set _modeloptions.penis to "default">>
						<</if>>
						<<if $neverNudeMenus>>
							<<if _slot != "under_upper" and (_mannequinGender == "f" or _mannequinGender == "h")>>
								<<set _modeloptions.worn_under_upper to 12>>
								<<set _modeloptions.worn_under_upper_colour to "pale white">>
							<</if>>
							<<if _slot != "under_lower" and (_item.set == _slot or _slot != 'under_upper')>>
								<<if $mannequinHasPenis>>
									<<set _modeloptions.worn_under_lower to 0>>
									<<set _modeloptions.worn_under_lower_colour to "pale white">>
								<</if>>
							<</if>>
						<</if>>
						<!-- Draw primary and all secondary items -->
						<<set _items_list = [{slot: _slot, item: _item}]>>
						<<if _item.outfitPrimary>>
							<<set _items_list = _items_list.concat(Object.keys(_item.outfitPrimary).map(s => { return {slot: s, item: setup.clothes[s].find(x => x.name == _item.outfitPrimary[s])} }))>>
						<</if>>
						<<for _clothing range _items_list>>
							<<set _item = _clothing.item>>
							<<set _slot = _clothing.slot>>
							<<set _modeloptions['worn_' + _slot] to _item.index>>
							<<if _col>>
								<<set _modeloptions['worn_' + _slot + '_colour'] to _col>>
								<<if _col is "custom">>
									<<set _modeloptions.filters["worn_" + _slot + "_custom"] =
											getCustomClothesColourCanvasFilter($customColors.color.primary,
												$customColors.saturation.primary,
												$customColors.brightness.primary,
												$customColors.contrast.primary);>>
								<</if>>
							<</if>>
							<<if _acc_col>>
								<<set _modeloptions['worn_' + _slot + '_acc_colour'] to _acc_col>>
								<<if _acc_col is "custom">>
									<<set _modeloptions.filters["worn_" + _slot + "_acc_custom"] =
											getCustomClothesColourCanvasFilter($customColors.color.secondary,
												$customColors.saturation.secondary,
												$customColors.brightness.secondary,
												$customColors.contrast.secondary);>>
								<</if>>
							<</if>>
						<</for>>
						<<if $sidebarRenderer is "both">>
							<<set _item = _items_list[0].item>>
							<<set _slot = _items_list[0].slot>>
						<</if>>
					<<rendermodel "canvas-mannequin">>
				<</if>>

				<<if $sidebarRenderer isnot "canvas">>
				<div class="mannequin-body">
					<img src="img/body/mannequin/leftarmidle.png">
					<img src="img/body/mannequin/basenoarms.png">
					<img src="img/body/mannequin/rightarmidle.png">
					<img src="img/body/mannequin/basehead.png">
					<img @src="'img/body/mannequin/breasts/' + _breastImg + _clothed + '.png'">
					<<if $mannequinHasPenis>>
						<img src="img/body/mannequin/penis.png">
					<</if>>

					<<if $neverNudeMenus>>
						<div class="neverNudeMenus">
							<<if _slot != "under_upper" and (_mannequinGender == "f" or _mannequinGender == "h")>>
								<div class="layer-under_upper clothes-pale-white">
									<img src="img/clothes/under_upper/plainbra/full.png">
									<img @src="'img/clothes/under_upper/plainbra/' + _breastImg + '.png'">
								</div>
							<</if>>
							<<if _slot != "under_lower" and (_item.set == _slot or _slot != 'under_upper')>>
								<div class="layer-under_lower clothes-pale-white">
									<img src="img/clothes/under_lower/plainpanties/full.png">
									<<if $mannequinHasPenis>>
										<img src="img/clothes/under_lower/plainpanties/penis.png">
									<</if>>
								</div>
							<</if>>
						</div>
					<</if>>
				</div>
				<</if>> <!-- renderer switch -->

				<!-- Mannequin gender toggle button -->
				<div class="mannequin-buttons no-numberify">
					<div class="div-link mannequin-gender-button">
						<<if $images is 1>>
							<<set _genderIcon = (_mannequinGender == "m" ? "male" : (_mannequinGender == "f" ? "female" : "unisex"))>>
							<img @src="'img/misc/icon/' + _genderIcon + '.png'">
						<<else>>
							<span class="capitalize">_manequinGender[0]</span>
						<</if>>
						<<link "">><<toggleMannequinGender>><</link>>
					</div>
				</div>

				<<if $sidebarRenderer isnot "canvas">>
				<div class="mannequin-clothes">
					<<unset _styleP>>
					<<unset _styleS>>
					<!-- Draw primary and all secondary items -->
					<<set _items_list = [{slot: _slot, item: _item}]>>
					<<if _item.outfitPrimary>>
						<<set _items_list = _items_list.concat(Object.keys(_item.outfitPrimary).map(s => { return {slot: s, item: setup.clothes[s].find(x => x.name == _item.outfitPrimary[s])} }))>>
					<</if>>
					<<for _clothing range _items_list>>
						<<set _item = _clothing.item>>
						<<set _slot = _clothing.slot>>

						<<if _col is "custom">>
							<<set _styleP = getCustomColourStyle('primary')>>
						<</if>>
						<div @class="'clothes-' + _col.replace(/ /g, '-')" @style="_styleP">
							<<if _item.mainImage isnot 0>>
								<img @src="'img/clothes/' + _slot + '/' + _item.variable + '/full.png'">
							<</if>>

							<<if _item.sleeve_img or _item.leftImage>>
								<img @src="'img/clothes/' + _slot + '/' + _item.variable + '/left.png'">
							<</if>>
							<<if _item.sleeve_img or _item.rightImage>>
								<img @src="'img/clothes/' + _slot + '/' + _item.variable + '/right.png'">
							<</if>>

							<<if _item.breast_img>>
								<img @src="'img/clothes/' + _slot + '/' + _item.variable + '/' + _breastImg + '.png'">
							<</if>>

							<<if _item.penis_img and $mannequinHasPenis>>
								<img @src="'img/clothes/' + _slot + '/' + _item.variable + '/penis.png'">
							<</if>>
						</div>

						<<if _acc_col is "custom">>
							<<set _styleS = getCustomColourStyle('secondary')>>
						<</if>>
						<div @class="'clothes-' + _acc_col.replace(/ /g, '-')" @style="_styleS">
							<<if _item.accessory and _slot != "hands">>
								<img @src="'img/clothes/' + _slot + '/' + _item.variable + (_item.accessory_integrity_img ? '/acc_full.png' : '/acc.png')">
							<</if>>
							<<if _item.breast_acc_img>>
								<img @src="'img/clothes/' + _slot + '/' + _item.variable + '/' + _breastImg + '_acc.png'">
							<</if>>
							<<if _item.leftImage and _item.accessory>>
								<img @src="'img/clothes/' + _slot + '/' + _item.variable + '/left_acc.png'">
							<</if>>
							<<if _item.rightImage and _item.accessory>>
								<img @src="'img/clothes/' + _slot + '/' + _item.variable + '/right_acc.png'">
							<</if>>
						</div>
						<<if _item.back_img is 1>>
							<<set _back_col = _item.back_img_colour is 'secondary' ? _acc_col.replace(/ /g, '-') : _col.replace(/ /g, '-')>>
							<div @class="'clothes-' + _back_col" @style="'z-index: -1; position: absolute; ' + _styleS">
								<img @src="'img/clothes/' + _slot + '/' + _item.variable + '/' + 'back.png'">
							</div>
						<</if>>
					<</for>>
				</div>
				<</if>> <!-- renderer switch -->
			</div>
			<div class="div-link mannequin-gender-textbutton no-numberify">
				Toggle gender
				<<link "">><<toggleMannequinGender>><</link>>
			</div>
		<</if>>
	<</if>>
<</widget>>

<<widget "toggleMannequinGender">>
	<<if _mannequinGender == "f">>
		<<set _mannequinGenderOverrite = "m">>
	<<else>>
		<<set _mannequinGenderOverrite = "f">>
	<</if>>
	<<updatemannequin>>
<</widget>>

<<widget "updatemannequin">>
	<<replace "#mannequin">><<mannequin $args[0] $args[1]>><</replace>>
	<<run linkifyDivs('#mannequin')>>
<</widget>>

<<widget "updatesidebardescription">>
	<<replace '#sidebar-look-description'>><<sidebarlookdescription>><</replace>>
<</widget>>

<<widget "updatesidebarmoney">>
	<<if $images>>
		<<replace #stats>><<statsCaption>><</replace>>
	<<else>>
		<<replace #money-noimg>><<statsMoneyNoImg>><</replace>>
	<</if>>
<</widget>>

<<widget "loadFiltersMenu">>
	<div class="filters-div" onclick="event.stopPropagation()">
		<div id="filter-buttons" class="filter-buttons-div">
			<div class="filter-button button-apply div-link">
				<<link "Apply and Close">>
					<<set $shopClothingFilter.active = true>>
					<<set $shopPage to 0>>
					<<addclass '#filters' 'hidden'>>
					<<updateclotheslist>>
					<<run updateMoment()>>
				<</link>>
			</div>
			<div class="filter-button button-reset div-link">
				<<link "Reset All and Close">>
					<<shopClothingFilterReset>>
					<<updateclotheslist>>
					<<run updateMoment()>>
				<</link>>
			</div>
			<div class="filter-button button-toggle-traits div-link">
				<<link "Select / Deselect All Traits">>
					<<run toggleAllTraitsFilter()>>
				<</link>>
			</div>
		</div>
		<div class="filters">
			<div id="filter-gender" class="filter-block">
				<<if typeof $shopClothingFilter.gender isnot "object">>
					<<set $shopClothingFilter.gender = { female: true, neutral: true, male: true }>>
				<</if>>

				<span class="bold gold">Gender</span>
				<label><<checkbox "$shopClothingFilter.gender.female" false true `$shopClothingFilter.gender.female ? "checked" : ""`>> Female</label>
				<label><<checkbox "$shopClothingFilter.gender.neutral" false true `$shopClothingFilter.gender.neutral ? "checked" : ""`>> Unisex</label>
				<label><<checkbox "$shopClothingFilter.gender.male" false true `$shopClothingFilter.gender.male ? "checked" : ""`>> Male</label>
			</div>

			<div id="filter-reveal" class="filter-block">
				<<filterreveal>>
			</div>

			<div id="filter-warmth" class="filter-block">
				<<if $shopClothingFilter.warmth is undefined>>
					<<set $shopClothingFilter.warmth = { from: 0, to: 200 }>>
				<</if>>

				<span class="bold gold">Warmth</span>
				<div class="filter-warmth-fromto">
					<label>from <<numberbox "$shopClothingFilter.warmth.from" $shopClothingFilter.warmth.from>></label>
					<label>to <<numberbox "$shopClothingFilter.warmth.to" $shopClothingFilter.warmth.to>></label>
				</div>
			</div>

			<div id="filter-traits" class="filter-block">
				<span class="bold gold">Traits</span>
				<div class="traits-list">
					<<set _traitsInThisShop = [...new Set(Object.keys(setup.clothes).flatMap(x => setup.clothes[x]).filter(x => x.shop.includes(_shopLocation)).flatMap(x => x.type))]>>
					<<for _trait range _traitsInThisShop>>
						<div class="filters-trait-row">
							<label>
								<<set _checked = $shopClothingFilter.traits.includes(_trait) ? 'checked="checked"' : ''>>
								<<print '<input type="checkbox" @id="_trait" @value="_trait" ' + _checked + ' onclick="window.shopClothingFilterToggleTrait(this.value)">'>>
								<<clothingtrait _trait 'display_normal'>>
								<span class="capitalize"><<print _trait.replace('_', ' ')>></span>
							</label>
						</div>
					<</for>>
				</div>
			</div>
		</div>
	</div>
<</widget>>

<<widget "filterreveal">>
	<<if $shopClothingFilter.reveal.from is undefined>>
		<<set $shopClothingFilter.reveal.from = 0>>
	<</if>>
	<<if $shopClothingFilter.reveal.to is undefined>>
		<<set $shopClothingFilter.reveal.to = 9999>>
	<</if>>
	<span class="bold gold">Reveal</span>
	<div class="filter-reveal-fromto">
		<label>from <<listbox "$shopClothingFilter.reveal.from" autoselect>><<optionsfrom getFilterRevealOptions('from')>><</listbox>></label>
		<label>to <<listbox "$shopClothingFilter.reveal.to" autoselect>><<optionsfrom getFilterRevealOptions('to')>><</listbox>></label>
	</div>

	<<run $(() => { $('#filter-reveal select').on('change', (e) => { new Wikifier(null, "<<replace '#filter-reveal'>><<filterreveal>><</replace>>"); }) })>>
<</widget>>

<<widget "loadShopOptions">>
	<div class="options-div" onclick="event.stopPropagation()">
		<div id="options-buttons" class="options-buttons-div">
			<div class="options-button button-apply div-link">
				<<link "Save and Close">>
					<<addclass '#shop-options' 'hidden'>>
					<<updateclotheslist>>
					<<run updateMoment()>>
				<</link>>
			</div>
		</div>
		<div class="options-body">
			<<set _colorOptions to ["black", "blue", "brown", "green", "pink", "purple", "red", "tangerine", "teal", "white", "yellow", "custom", "random"]>>

			<br>
			Default primary colour:
			<br>
			<<for _col range _colorOptions>>
				<label>
					<<print '<<radiobutton "$shopDefaults.color" "'+ _col +'" ' + ($shopDefaults.color is _col ? "checked" : "") + '>>'>>
					<<print '<span class="'+ _col +'">' + _col + '</span>'>>
				</label>
				|
			<</for>>
			<br><br>
			Default secondary colour:
			<br>
			<<for _col range _colorOptions>>
				<label>
					<<print '<<radiobutton "$shopDefaults.secColor" "'+ _col +'" ' + ($shopDefaults.secColor is _col ? "checked" : "") + '>>'>>
					<<print '<span class="'+ _col +'">' + _col + '</span>'>>
				</label>
				|
			<</for>>
			<br><hr>

			<label>
				<<print '<<checkbox "$shopDefaults.disableReturn" false true ' + ($shopDefaults.disableReturn is true? "checked" : "")+'>>'>>
				Don't return to catalogue after buying an item.
			</label>
			<br><hr>

			<label>
				<<print '<<checkbox "$shopDefaults.alwaysBackToShopButton" false true ' + ($shopDefaults.alwaysBackToShopButton is true? "checked" : "")+'>>'>>
				Always show "Back to shop" button.
			</label>
			<br><hr>

			<<if $shopDefaults.colourItems is undefined>>
				<<set $shopDefaults.colourItems = "random">>
			<</if>>
			<label>
				Colour items in catalogue:
				<<listbox "$shopDefaults.colourItems" autoselect>>
					<<option "Disable" "disable">>
					<<option "Use random colours" "random">>
					<<option "Use default colour" "default">>
				<</listbox>>
			</label>
			<br><hr>

			<label>
				Amount of items on each page of catalogue:
				<<listbox "$shopItemsPerPage" autoselect>>
					<<optionsfrom [4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32]>>
				<</listbox>>
			</label>
			<br><hr>

			<div class="high-contrast-example">
				<label>
					<<print '<<checkbox "$shopDefaults.highContrast" false true ' + ($shopDefaults.highContrast is true? "checked" : "")+'>>'>>
					Use high contrast text on colour buttons.
				</label>
				&nbsp;&nbsp;Example:&nbsp;&nbsp;
				<div class="colour-button"><div class="bg-pink"><span class="capitalize colour-name-span">pink</span></div></div>
				&nbsp;<span style="margin-right:0.25em">vs</span>&nbsp;
				<div class="colour-button"><div class="bg-pink"><span class="capitalize colour-name-span-highcontrast">pink</span></div></div>
			</div>
			<hr>

			<label>
				<<print '<<checkbox "$shopDefaults.mannequinGenderFromClothes" false true ' + ($shopDefaults.mannequinGenderFromClothes is true? "checked" : "")+'>>'>>
				Set mannequin's gender to that of a clothing item (fallback to setting below for unisex).
			</label>
			<br>
			<label>
				Gender of the mannequin:
				<<listbox "$shopDefaults.mannequinGender" autoselect>>
					<<option "Same as player" "same">>
					<<option "Opposite of player" "opposite">>
					<<option "Always male" "male">>
					<<option "Always female" "female">>
				<</listbox>>
			</label>
			<br>
			<label>
				Mannequin chest size:
				<<listbox "$mannequinBreastsSize" autoselect>>
					<<optionsfrom {"Flat": 0 , "Tiny": 1, "Small": 2, "Full": 3, "Large": 4, "Huge": 5}>>
				<</listbox>>
			</label>
			<br><hr>

			<label>
				<<print '<<checkbox "$shopDefaults.compactMode" false true ' + ($shopDefaults.compactMode is true? "checked" : "")+'>>'>>
				Display less information to make catalogue more compact.
			</label>
			<br>
			<label>
				<<print '<<checkbox "$shopDefaults.noTraits" false true ' + ($shopDefaults.noTraits is true? "checked" : "")+'>>'>>
				Hide clothing trait icons.
			</label>
			<br>
			<label>
				<<print '<<checkbox "$shopDefaults.noHelp" false true ' + ($shopDefaults.noHelp is true? "checked" : "")+'>>'>>
				Don't show help / legend button in catalogue.
			</label>
		</div>
	</div>
<</widget>>

<<widget "clothingShopLegend">>
	<div id="shop-legend" class="shop-legend hidden">
		<div class="legend-caption bold gold">Legend</div>
		<br>

		<<if $images is 1>>
			<div>
				<img src="img/misc/icon/integrity.png">
				Integrity rating. How hard it is to tear clothing into scraps.
			</div>
			<div>
				<img src="img/misc/icon/reveal.png">
				Reveal rating. How alluring clothing makes you.
			</div>
			<div>
				<img src="img/misc/icon/warmth.png">
				Warmth rating. How good clothing protects you from cold.
			</div>
			<br>

			<div class="legend-2em">
				<img src="img/misc/icon/options.png">
				Clothing shop options.
			</div>
			<div class="legend-2em">
				<img src="img/misc/icon/filter.png">
				Clothing shop filters.
			</div>
			<br>
		<<else>>
			I - Integrity rating. How hard it is to tear clothing into scraps.
			<br>
			R - Reveal rating. How alluring clothing makes you.
			<br>
			W - Warmth rating. How good clothing protects you from cold.
		<</if>>

		<div class="legend-warmth">
			<div class="legend-warmth-div">
				<<warmthscale $warmth+25>>
			</div>
			Warmth indicator.
			<br>
			Displays comfortable temperature range, depends on weather.
			<br>
			<div class="legend-colour-sample" style="background-color: dodgerblue"></div> - you will be too cold at this temperature
			<br>
			<div class="legend-colour-sample" style="background-color: lightskyblue"></div> - you will be a bit chilly at this temperature
			<br>
			<div class="legend-colour-sample" style="background-color: lemonchiffon"></div> - perfect temperature
			<br>
			<div class="legend-colour-sample" style="background-color: orange"></div> - you will be a bit too warm at this temperature
			<br>
			<div class="legend-colour-sample" style="background-color: orangered"></div> - you will be way too hot at this temperature
			<br>
			<div class="legend-icon"><img src="img/misc/icon/warmth_indicator.png"></div> - your warmth with your current clothes on
			<br>
			<div class="legend-icon"><img src="img/misc/icon/small_uarrow.png"></div> - warmth you'd have would you put other clothing on instead
		</div>
	</div>
<</widget>>

<<widget "warmthscale">>
	<div class="warmth-scale-container">
		<<warmthscale-internal $args[0]>>
	</div>
<</widget>>

<<widget "updatewarmthscale">>
	<<temperature>>
	<<replace '.warmth-scale-container'>><<warmthscale-internal>><</replace>>
<</widget>>

<<widget "updatewarmthdescription">>
	<<replace '#warmth-description'>><<warmth_description>><</replace>>
<</widget>>

<<widget "warmthscale-internal">>
	<<if $args[0]>>
		<<set _newWarmth = $args[0]>>
	<<elseif $clothes_choice>>
		<<set _newWarmth = getWarmthWithOtherClothing($clothingShopSlot, $clothes_choice)>>
	<</if>>
	<<set _warmthData = getWarmthScaleData(_newWarmth)>>

	<div class="warmth-scale-div">
		<div class="cold" @style="'width: ' + _warmthData.cold"></div>
		<div @class="'chill ' + _warmthData.nocold" @style="'width: ' + _warmthData.chill"></div>
		<div @class="'ok ' + _warmthData.nowarm" @style="'width: ' + _warmthData.ok"></div>
		<div @class="'warm ' + _warmthData.nohot" @style="'width: ' + _warmthData.warm"></div>
		<div class="hot" @style="'width: ' + _warmthData.hot"></div>

		<<if $clothes_choice or $args[0]>>
			<div @class="'diff ' + _warmthData.diffUpDown" @style="'left: ' + _warmthData.diffStart + '; width: ' + _warmthData.diffWidth"></div>
		<</if>>
	</div>

	<img src="img/misc/icon/warmth_indicator.png" class="warmth-indicator" @style="'left: ' + _warmthData.player">
	<<if $clothes_choice or $args[0]>>
		<img src="img/misc/icon/small_uarrow.png" class="warmth-indicator" @style="'left: ' + _warmthData.playerNew">
	<</if>>
<</widget>>
